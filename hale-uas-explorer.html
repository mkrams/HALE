<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HALE UAS Interactive System Explorer — Reviewed</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f172a;--card:#1e293b;--card2:#334155;--border:#475569;--text:#e2e8f0;--muted:#94a3b8;--accent:#3b82f6;--green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#a78bfa;--teal:#14b8a6;--pink:#f472b6;--sky:#38bdf8;--yellow:#eab308;--rose:#fb7185}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;display:flex;flex-direction:column}
.topbar{background:#1a1a2e;padding:10px 20px;display:flex;align-items:center;gap:16px;border-bottom:1px solid #2d2d44;flex-shrink:0;z-index:100;flex-wrap:wrap}
.topbar h1{font-size:16px;font-weight:700;color:#fff}
.topbar .pill{background:var(--accent);padding:2px 10px;border-radius:10px;font-size:10px;font-weight:700;color:#fff}
.topbar .pill.review{background:var(--rose)}
.topbar .controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.topbar button{background:var(--card);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:5px;font-size:11px;cursor:pointer}
.topbar button:hover{background:var(--card2)}
.topbar button.active{background:var(--accent);border-color:var(--accent)}
.topbar button.issues-btn.active{background:var(--rose);border-color:var(--rose)}
.legend{display:flex;gap:12px;font-size:10px;color:var(--muted);align-items:center;flex-wrap:wrap}
.legend span{display:flex;align-items:center;gap:4px}
.legend .dot{width:8px;height:8px;border-radius:50%}
.workspace{flex:1;display:flex;overflow:hidden;position:relative}
canvas{position:absolute;top:0;left:0}
#mainCanvas{z-index:1}
#connCanvas{z-index:0}
.detail-panel{position:absolute;right:0;top:0;bottom:0;width:400px;background:#1a1a2e;border-left:1px solid #2d2d44;z-index:50;transform:translateX(100%);transition:transform .25s ease;overflow-y:auto;padding:0}
.detail-panel.open{transform:translateX(0)}
.dp-header{padding:16px;border-bottom:1px solid #2d2d44;display:flex;align-items:center;gap:10px}
.dp-header .icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff}
.dp-header h2{font-size:15px;font-weight:700;flex:1}
.dp-close{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px 8px}
.dp-close:hover{color:#fff}
.dp-section{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.05)}
.dp-section h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px}
.dp-section p{font-size:12px;line-height:1.6;color:var(--text)}
.dp-props{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.dp-prop{background:rgba(255,255,255,.04);padding:6px 8px;border-radius:4px;font-size:11px}
.dp-prop .k{color:var(--muted);font-size:10px}
.dp-prop .v{color:#fff;font-weight:600}
.dp-tag{display:inline-block;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:600;margin:2px}
.dp-conn{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;cursor:pointer;border-radius:4px;padding:4px 6px}
.dp-conn:hover{background:rgba(255,255,255,.06)}
.dp-conn .arrow{color:var(--muted)}
.tooltip{position:absolute;background:#1e293b;border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:11px;color:var(--text);pointer-events:none;z-index:200;max-width:260px;box-shadow:0 4px 12px rgba(0,0,0,.4);display:none}
.search-box{background:var(--card);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:5px;font-size:11px;width:180px}
.search-box::placeholder{color:var(--border)}
.issues-drawer{position:absolute;left:0;top:0;bottom:0;width:360px;background:#1a1a2e;border-right:1px solid #2d2d44;z-index:50;transform:translateX(-100%);transition:transform .25s ease;overflow-y:auto;padding:0}
.issues-drawer.open{transform:translateX(0)}
.issues-drawer h2{font-size:14px;padding:16px;border-bottom:1px solid #2d2d44;display:flex;align-items:center;gap:8px}
.issues-drawer h2 .badge{background:var(--rose);color:#fff;font-size:10px;padding:2px 8px;border-radius:8px}
.issue-card{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.05);cursor:pointer}
.issue-card:hover{background:rgba(255,255,255,.03)}
.issue-card .issue-type{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.issue-card .issue-type .dot{width:6px;height:6px;border-radius:50%}
.issue-card .issue-title{font-size:12px;font-weight:600;margin-bottom:4px;color:#fff}
.issue-card .issue-desc{font-size:11px;color:var(--muted);line-height:1.5}
.issue-card .issue-refs{margin-top:6px;display:flex;flex-wrap:wrap;gap:4px}
.issue-card .ref-chip{font-size:9px;background:rgba(255,255,255,.06);padding:2px 6px;border-radius:4px;color:var(--sky);cursor:pointer}
.issue-card .ref-chip:hover{background:rgba(255,255,255,.12)}
.close-drawer{position:absolute;right:12px;top:14px;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer}
.close-drawer:hover{color:#fff}
.stats-bar{display:flex;gap:12px;padding:10px 16px;border-bottom:1px solid #2d2d44;font-size:10px;color:var(--muted)}
.stats-bar .stat{display:flex;align-items:center;gap:4px}
.stats-bar .stat .n{color:#fff;font-weight:700;font-size:12px}
</style>
</head>
<body>
<div class="topbar">
  <h1>HALE UAS System Explorer</h1>
  <span class="pill">INTERACTIVE</span>
  <span class="pill review">REVIEWED</span>
  <div class="legend">
    <span><span class="dot" style="background:var(--accent)"></span>System</span>
    <span><span class="dot" style="background:var(--sky)"></span>Component</span>
    <span><span class="dot" style="background:var(--green)"></span>Subsystem</span>
    <span><span class="dot" style="background:var(--purple)"></span>External</span>
    <span><span class="dot" style="background:var(--orange)"></span>Requirement</span>
    <span><span class="dot" style="background:var(--red)"></span>Function</span>
    <span><span class="dot" style="background:var(--pink)"></span>Mission</span>
    <span><span class="dot" style="background:var(--yellow)"></span>Challenge</span>
    <span><span class="dot" style="background:var(--rose)"></span>Issue</span>
  </div>
  <div class="controls">
    <input class="search-box" id="searchBox" placeholder="Search nodes..." oninput="searchNodes(this.value)">
    <button id="btnIssues" class="issues-btn" onclick="toggleIssues()">Issues (12)</button>
    <button id="btnAll" class="active" onclick="setLayer('all')">All</button>
    <button id="btnPhys" onclick="setLayer('physical')">Physical</button>
    <button id="btnReq" onclick="setLayer('requirements')">Requirements</button>
    <button id="btnFunc" onclick="setLayer('functions')">Functions</button>
    <button id="btnMsn" onclick="setLayer('missions')">Missions</button>
    <button id="btnChal" onclick="setLayer('challenges')">Challenges</button>
    <button onclick="resetView()">Reset View</button>
  </div>
</div>
<div class="workspace" id="workspace">
  <canvas id="connCanvas"></canvas>
  <canvas id="mainCanvas"></canvas>
  <div class="detail-panel" id="detailPanel">
    <div class="dp-header">
      <div class="icon" id="dpIcon">S</div>
      <h2 id="dpTitle">&mdash;</h2>
      <button class="dp-close" onclick="closePanel()">&times;</button>
    </div>
    <div id="dpContent"></div>
  </div>
  <div class="issues-drawer" id="issuesDrawer">
    <h2>Review Findings <span class="badge" id="issueCount">12</span></h2>
    <button class="close-drawer" onclick="toggleIssues()">&times;</button>
    <div class="stats-bar">
      <div class="stat"><span class="dot" style="background:var(--rose);width:6px;height:6px;border-radius:50%;display:inline-block"></span><span class="n" id="conflictCount">4</span> Conflicts</div>
      <div class="stat"><span class="dot" style="background:var(--orange);width:6px;height:6px;border-radius:50%;display:inline-block"></span><span class="n" id="gapCount">8</span> Missing Traces</div>
    </div>
    <div id="issuesList"></div>
  </div>
  <div class="tooltip" id="tooltip"></div>
</div>

<script>
// =========================================================================
// DATA MODEL — Updated with review findings
// =========================================================================
const NODES = [
  // System
  {id:'sys',label:'HALE UAS\nSystem',type:'system',layer:'physical',x:0,y:0,w:160,h:56,color:'#3b82f6',desc:'Top-level HALE UAS System — integrates all elements for file-and-fly NAS operations.',props:{operatesUnderIFR:'IFR',hasOperatingCerts:true,canFileAndFly:true,hasContingencyPlan:true,hasAutoLand:true},expanded:true,children:['ua','cs','comms','pilot']},
  // Physical components
  {id:'ua',label:'Unmanned\nAircraft',type:'component',layer:'physical',x:-320,y:150,w:140,h:48,color:'#38bdf8',desc:'The unmanned aircraft element (Section 2.1.1). Includes airframe, avionics, propulsion, collision avoidance, and navigation systems.',props:{maxAltitude:'≥ 40,000 ft MSL',maxEndurance:'≥ 24 hrs',hasCollisionAvoidance:true,hasTransponder:true,hasFlightRecovery:true,hasWeatherDetection:true,hasAutoLand:true,isRegistered:true,hasTypeCert:true,hasAirworthinessCert:true},expanded:false,children:['ua_airframe','ua_prop','ua_fltctrl','ua_ca','ua_nav','ua_wx','ua_frs','ua_transponder','ua_elec','ua_autoland']},
  {id:'cs',label:'Control\nStation',type:'component',layer:'physical',x:-100,y:150,w:130,h:48,color:'#38bdf8',desc:'Control Station & Ground Support element (Section 2.1.2). Provides mission planning, aircraft control, launch/recovery, maintenance.',props:{isTypeCertified:true,isConfigControlled:true,hasSecurityMeasures:true,supportsMissionPlanning:true,supportsAircraftControl:true,supportsLaunchRecovery:true,supportsMaintenance:true}},
  {id:'comms',label:'Data & Voice\nComm Links',type:'component',layer:'physical',x:130,y:150,w:140,h:48,color:'#38bdf8',desc:'Data and Voice Communication Links element (Section 2.1.3). Provides C2 uplink/downlink and voice ATC communications.',props:{supportsLOS:true,supportsOTH:true,supportsVoiceATC:true,supportsC2Uplink:true,supportsC2Downlink:true,usesAuthSpectrum:true,isHighlyAvailable:true,isReliable:true,isSecure:true},expanded:false,children:['comms_los','comms_oth','comms_satcom','comms_relay','comms_landline']},
  {id:'pilot',label:'Pilot-in-\nCommand',type:'component',layer:'physical',x:350,y:150,w:120,h:48,color:'#38bdf8',desc:'Certificated UAS pilot/operator (Section 3.1.3). Must hold Part 61 certificate with instrument rating.',props:{hasPilotCert:true,hasInstrumentRating:true,hasMedicalCert:true,meetsCurrency:true,isCertifiedPart61:true}},
  // UA subsystems
  {id:'ua_airframe',label:'Airframe &\nStructures',type:'subsystem',layer:'physical',x:-520,y:310,w:110,h:40,color:'#10b981',desc:'Aircraft airframe and structural components.'},
  {id:'ua_prop',label:'Propulsion',type:'subsystem',layer:'physical',x:-400,y:310,w:100,h:40,color:'#10b981',desc:'Propulsion system (varies by aircraft type: solar, turboprop, jet).'},
  {id:'ua_fltctrl',label:'Flight\nControls',type:'subsystem',layer:'physical',x:-290,y:310,w:100,h:40,color:'#10b981',desc:'Flight Management Control System (FMCS). Processes pilot commands and autonomous flight plans.'},
  {id:'ua_ca',label:'Collision\nAvoidance',type:'subsystem',layer:'physical',x:-180,y:310,w:110,h:40,color:'#10b981',desc:'Sense & Avoid system. Must perform 7 functions: detect, track, evaluate, prioritize, determine maneuver, command, execute (Section 5.2).'},
  {id:'ua_nav',label:'Navigation',type:'subsystem',layer:'physical',x:-520,y:370,w:100,h:40,color:'#10b981',desc:'Navigation systems including GPS, WAAS, LAAS for precision approach. Supplemental nav needed for GPS-independent operation (Section 5.2).'},
  {id:'ua_wx',label:'Weather\nDetection',type:'subsystem',layer:'physical',x:-410,y:370,w:110,h:40,color:'#10b981',desc:'Weather detection & avoidance equipment — ensures proper separation from adverse weather (Section 5.2).'},
  {id:'ua_frs',label:'Flight Recovery\nSystem',type:'subsystem',layer:'physical',x:-290,y:370,w:120,h:40,color:'#10b981',desc:'Flight Recovery/Termination system for contingencies when landing cannot be performed at designated airfield (Section 5.2).'},
  {id:'ua_transponder',label:'ATC\nTransponder',type:'subsystem',layer:'physical',x:-160,y:370,w:110,h:40,color:'#10b981',desc:'ATC radar transponder for cooperative surveillance and separation.'},
  {id:'ua_elec',label:'Electrical\nSystem',type:'subsystem',layer:'physical',x:-520,y:430,w:110,h:40,color:'#10b981',desc:'Electrical system including position and strobe lights (Section 5.2). Required basic operating equipment.'},
  {id:'ua_autoland',label:'Auto-Land\nSystem',type:'subsystem',layer:'physical',x:-400,y:430,w:110,h:40,color:'#10b981',desc:'Auto-land system for autonomous landing at UAS-designated airports in event of C2 link loss (Section 5.2). REVIEW: Conflicts with REQ-HITL.'},
  // Comms subsystems
  {id:'comms_los',label:'LOS\nComms',type:'subsystem',layer:'physical',x:60,y:310,w:90,h:40,color:'#10b981',desc:'Line-of-Sight communication links for near-field operations.'},
  {id:'comms_oth',label:'OTH\nComms',type:'subsystem',layer:'physical',x:160,y:310,w:90,h:40,color:'#10b981',desc:'Over-the-Horizon communication links for long-range operations.'},
  {id:'comms_satcom',label:'Satellite\nComm',type:'subsystem',layer:'physical',x:60,y:370,w:100,h:40,color:'#10b981',desc:'Satellite communication services for OTH C2 relay.'},
  {id:'comms_relay',label:'Airborne/\nGround Relay',type:'subsystem',layer:'physical',x:170,y:370,w:110,h:40,color:'#10b981',desc:'Airborne or ground-based relay communication services.'},
  {id:'comms_landline',label:'Landline\nComm',type:'subsystem',layer:'physical',x:110,y:430,w:110,h:40,color:'#10b981',desc:'Landline communication services — emergency-only direct phone to ATC center controller (Section 4.5.4).'},
  // External entities
  {id:'ext_faa',label:'FAA /\nRegulators',type:'external',layer:'physical',x:500,y:-100,w:120,h:44,color:'#a78bfa',desc:'Federal Aviation Administration. Provides regulatory oversight, certification authority, and COA issuance.'},
  {id:'ext_atc_dep',label:'Local ATC\n(Departure)',type:'external',layer:'physical',x:440,y:40,w:120,h:44,color:'#a78bfa',desc:'Local ATC at departure airport: clearance, ground, tower, ATIS (Section 4.3.2).'},
  {id:'ext_tracon',label:'TRACON /\nARTCC',type:'external',layer:'physical',x:530,y:120,w:120,h:44,color:'#a78bfa',desc:'Departure Control, En-Route Control (ARTCC), and Approach Control (Section 4.3.2).'},
  {id:'ext_atc_dest',label:'Local ATC\n(Destination)',type:'external',layer:'physical',x:530,y:200,w:120,h:44,color:'#a78bfa',desc:'Local ATC at destination airport: ATIS, tower, ground (Section 4.3.2).'},
  {id:'ext_fss',label:'Flight Service\nStation',type:'external',layer:'physical',x:440,y:280,w:120,h:44,color:'#a78bfa',desc:'Provides weather briefings, NOTAMs, and flight plan filing/closing (Section 4.3.1).'},
  {id:'ext_airport',label:'Airport\nManagement',type:'external',layer:'physical',x:530,y:360,w:120,h:44,color:'#a78bfa',desc:'UAS-designated airport. Provides siting, safety, security, environmental, and logistics services (Section 4.5.2).'},
  {id:'ext_other_ac',label:'Other\nAircraft',type:'external',layer:'physical',x:350,y:-80,w:110,h:44,color:'#a78bfa',desc:'Cooperative (transponder-equipped) and non-cooperative aircraft in the NAS (Section 4.3.2).'},
  {id:'ext_fcc',label:'FCC / ITU',type:'external',layer:'physical',x:350,y:380,w:100,h:44,color:'#a78bfa',desc:'Frequency spectrum authority. No UAS C2 frequencies currently allocated (Section 3.3.4).'},
  {id:'ext_icao',label:'ICAO',type:'external',layer:'physical',x:500,y:440,w:100,h:44,color:'#a78bfa',desc:'International Civil Aviation Organization — compliance needed for operations in international airspace (Section 5.4). ADDED from review.'},
  // Stakeholder roles from Table 3
  {id:'role_opsmgr',label:'Ops\nManager',type:'external',layer:'physical',x:210,y:-80,w:110,h:44,color:'#a78bfa',desc:'Operations Manager — develops mission/flight plan, monitors mission progress, ascertains mission success (Table 3). ADDED from review.'},
  {id:'role_ground',label:'Ground\nCrew',type:'external',layer:'physical',x:210,y:-20,w:110,h:44,color:'#a78bfa',desc:'Ground Crew — performs aircraft preflight, tow/taxi, launch/recovery, park and secure (Table 3). ADDED from review.'},
  {id:'role_payload',label:'Payload\nOps',type:'external',layer:'physical',x:210,y:40,w:110,h:44,color:'#a78bfa',desc:'Payload Operators — preflight, startup, operate, and shutdown payload systems (Table 3). ADDED from review.'},
  // Requirements
  {id:'r0',label:'REQ-0\nOverall',type:'requirement',layer:'requirements',x:-600,y:-120,w:110,h:44,color:'#f59e0b',desc:'UAS shall operate safely and routinely in the NAS.',props:{level:'Overall',source:'Table 2'}},
  {id:'r1',label:'REQ-1\nAirworthiness',type:'requirement',layer:'requirements',x:-700,y:-40,w:120,h:44,color:'#f59e0b',desc:'UAS shall be airworthy.',props:{level:'L1'}},
  {id:'r1_1',label:'REQ-1.1\nRegistration',type:'requirement',layer:'requirements',x:-800,y:40,w:120,h:40,color:'#f59e0b',desc:'The UAS shall be registered with the FAA.'},
  {id:'r1_2',label:'REQ-1.2\nAirworthiness Cert',type:'requirement',layer:'requirements',x:-800,y:90,w:130,h:40,color:'#f59e0b',desc:'The UAS shall obtain and maintain an airworthiness certificate.'},
  {id:'r1_3',label:'REQ-1.3\nELOS',type:'requirement',layer:'requirements',x:-800,y:140,w:110,h:40,color:'#f59e0b',desc:'The UAS shall meet an equivalent level of safety to manned GA aircraft. Most vulnerable requirement (3 failure scenarios).'},
  {id:'r2',label:'REQ-2\nSafe Operation',type:'requirement',layer:'requirements',x:-500,y:-40,w:130,h:44,color:'#f59e0b',desc:'UAS shall be operated safely in the NAS.'},
  {id:'r2_1',label:'REQ-2.1\nPart 91',type:'requirement',layer:'requirements',x:-550,y:40,w:110,h:40,color:'#f59e0b',desc:'Comply with 14 CFR Part 91.'},
  {id:'r2_2',label:'REQ-2.2\nOp Certs',type:'requirement',layer:'requirements',x:-550,y:90,w:110,h:40,color:'#f59e0b',desc:'Obtain operating certificates for Part 91 commercial operations.'},
  {id:'r2_3',label:'REQ-2.3\nIFR Ops',type:'requirement',layer:'requirements',x:-550,y:140,w:110,h:40,color:'#f59e0b',desc:'Flight operations under Instrument Flight Rules. REVIEW: Was only traced to pilot; now also traced to ua_nav and comms.'},
  {id:'r2_4',label:'REQ-2.4\nSeparation',type:'requirement',layer:'requirements',x:-550,y:190,w:110,h:40,color:'#f59e0b',desc:'Comply with FAA 7110.65 separation standards. REVIEW: Now also traced to ua_transponder and ua_ca.'},
  {id:'r2_5',label:'REQ-2.5\nQualified Human',type:'requirement',layer:'requirements',x:-550,y:240,w:130,h:40,color:'#f59e0b',desc:'An authorized and qualified human shall be responsible for the safe flight of each UAS.'},
  {id:'r2_6',label:'REQ-2.6\nContingency',type:'requirement',layer:'requirements',x:-550,y:290,w:120,h:40,color:'#f59e0b',desc:'Operate predictably in emergencies, similar to manned aircraft. REVIEW: Now traced to ua_frs and comms as well.'},
  {id:'r2_7',label:'REQ-2.7\nFreq Spectrum',type:'requirement',layer:'requirements',x:-550,y:340,w:120,h:40,color:'#f59e0b',desc:'The UAS shall utilize authorized frequency spectrum for C2 and payloads.'},
  {id:'rd_ca',label:'REQ-CA\nCollision Avoid',type:'requirement',layer:'requirements',x:-700,y:200,w:120,h:40,color:'#f59e0b',desc:'7-function collision avoidance: detect, track, evaluate, prioritize, determine, command, execute.'},
  {id:'rd_pfc',label:'REQ-PFC\nPositive Flt Ctrl',type:'requirement',layer:'requirements',x:-700,y:260,w:130,h:40,color:'#f59e0b',desc:'Positive flight control throughout planned route. REVIEW: Now also traced to ua_fltctrl and cs.'},
  {id:'rd_c2s',label:'REQ-C2SEC\nC2 Security',type:'requirement',layer:'requirements',x:-700,y:320,w:120,h:40,color:'#f59e0b',desc:'C2 link and CS security against external interference.'},
  {id:'rd_hitl',label:'REQ-HITL\nHuman-in-Loop',type:'requirement',layer:'requirements',x:-700,y:380,w:130,h:40,color:'#f59e0b',desc:'Human override authority at all times during flight operations. REVIEW: Now traced to cs. CONFLICT with auto-land on link loss.'},
  // NEW requirements from review (Sections 4.6 and 5.2)
  {id:'rd_nav',label:'REQ-NAV\nNavigation',type:'requirement',layer:'requirements',x:-800,y:200,w:120,h:40,color:'#f59e0b',desc:'Supplemental onboard navigation enabling precise navigation regardless of GPS status (Section 5.2). ADDED from review.'},
  {id:'rd_wx',label:'REQ-WX\nWeather Avoidance',type:'requirement',layer:'requirements',x:-800,y:260,w:130,h:40,color:'#f59e0b',desc:'Weather detection and avoidance ensuring proper separation from adverse weather (Section 5.2). ADDED from review.'},
  {id:'rd_atccomm',label:'REQ-ATCCOM\nATC Comms',type:'requirement',layer:'requirements',x:-800,y:320,w:130,h:40,color:'#f59e0b',desc:'Direct two-way ATC communications regardless of CS/UA location (Section 5.2). ADDED from review.'},
  {id:'rd_fltman',label:'REQ-FLTMAN\nFlight Manual',type:'requirement',layer:'requirements',x:-800,y:380,w:130,h:40,color:'#f59e0b',desc:'Conduct all operations per HALE UAS developer flight manual (Section 4.6 criterion #2). ADDED from review.'},
  {id:'rd_fltplan',label:'REQ-FLTPLN\nFlight Planning',type:'requirement',layer:'requirements',x:-800,y:440,w:130,h:40,color:'#f59e0b',desc:'Provide flight-planning info (comparable to piloted aircraft) to NAS for conflict prediction and scheduling (Section 4.6 criterion #3). ADDED from review.'},
  {id:'rd_cns',label:'REQ-CNS\nCNS/ATM Perf',type:'requirement',layer:'requirements',x:-700,y:440,w:130,h:40,color:'#f59e0b',desc:'Satisfy required CNS/ATM/pilot performance levels to meet existing separation criteria (Section 4.6 criterion #5). ADDED from review.'},
  // Functions
  {id:'f1',label:'F1: Operate\nSafely in NAS',type:'function',layer:'functions',x:-200,y:-200,w:130,h:44,color:'#ef4444',desc:'Top-level function: Operate safely and routinely in the NAS with file-and-fly capability.'},
  {id:'f1_1',label:'F1.1 Maintain\nAirworthiness',type:'function',layer:'functions',x:-380,y:-130,w:130,h:40,color:'#ef4444',desc:'Maintain aircraft and CS airworthiness per FAA certification.'},
  {id:'f1_2',label:'F1.2 Navigate\n& Fly IFR',type:'function',layer:'functions',x:-230,y:-130,w:120,h:40,color:'#ef4444',desc:'Navigate along IFR routes, execute flight profile.'},
  {id:'f1_3',label:'F1.3 Sense\n& Avoid',type:'function',layer:'functions',x:-90,y:-130,w:110,h:40,color:'#ef4444',desc:'Detect, track, and avoid other aircraft at all times.'},
  {id:'f1_4',label:'F1.4 Comm\nwith ATC',type:'function',layer:'functions',x:40,y:-130,w:110,h:40,color:'#ef4444',desc:'Two-way voice/data communication with ATC facilities.'},
  {id:'f1_5',label:'F1.5 Manage\nContingencies',type:'function',layer:'functions',x:170,y:-130,w:130,h:40,color:'#ef4444',desc:'Detect anomalies and execute pre-planned emergency procedures.'},
  {id:'f2',label:'F2: Maintain\nC2 Link',type:'function',layer:'functions',x:100,y:-200,w:120,h:44,color:'#ef4444',desc:'Maintain continuous command and control link between CS and UA.'},
  {id:'f2_1',label:'F2.1 C2\nUplink/Downlink',type:'function',layer:'functions',x:300,y:-130,w:120,h:40,color:'#ef4444',desc:'Provide reliable C2 data transfer in LOS and OTH modes.'},
  {id:'f2_2',label:'F2.2 Secure\nC2 Link',type:'function',layer:'functions',x:300,y:-75,w:110,h:40,color:'#ef4444',desc:'Maintain encryption and anti-jamming on C2 link.'},
  // NEW functions from review
  {id:'f1_6',label:'F1.6 Weather\nAvoidance',type:'function',layer:'functions',x:-380,y:-75,w:120,h:40,color:'#ef4444',desc:'Detect adverse weather and maintain separation from it (Section 5.2). ADDED from review.'},
  {id:'f1_7',label:'F1.7 Auto-Land\non Link Loss',type:'function',layer:'functions',x:-230,y:-75,w:130,h:40,color:'#ef4444',desc:'Autonomously land at UAS-designated airport on C2 link loss (Section 5.2). ADDED from review.'},
  {id:'f1_8',label:'F1.8 Mission\nPlanning',type:'function',layer:'functions',x:-90,y:-75,w:120,h:40,color:'#ef4444',desc:'Develop flight plan meeting user requirements while minimizing ATC impact (Section 4.5.1). ADDED from review.'},
  // Missions
  {id:'msn_loiter',label:'Loiter\nMission',type:'mission',layer:'missions',x:-150,y:500,w:120,h:44,color:'#f472b6',desc:'Telecom loiter mission (Section 4.4.1): Station-keep above metro area. Depart Airport A, loiter, return. ~24 hrs. LOS comms sufficient.',props:{altitude:'55,000 ft',duration:'24 hrs',commsMode:'LOS'}},
  {id:'msn_ptp',label:'Point-to-Point\nMission',type:'mission',layer:'missions',x:60,y:500,w:130,h:44,color:'#f472b6',desc:'Cross-country cargo mission (Section 4.4.2): Transit coast-to-coast. Requires OTH comms. Control handover possible.',props:{altitude:'50,000 ft',duration:'24 hrs',commsMode:'OTH',controlHandover:'possible'}},
  // 7 Challenge Areas (Section 3.3)
  {id:'ch1',label:'CH-1 Level\nof Safety',type:'challenge',layer:'challenges',x:700,y:-80,w:120,h:44,color:'#eab308',desc:'Challenge: Define appropriate UAS level of safety — drives airworthiness standards (Section 3.3.1). Requires proposal with adequate rationale.'},
  {id:'ch2',label:'CH-2 Airworthiness\nStandards',type:'challenge',layer:'challenges',x:700,y:-20,w:140,h:44,color:'#eab308',desc:'Challenge: Minimum airworthiness & operating standards. No standards exist yet for type/airworthiness certification of UAS (Section 3.3.2).'},
  {id:'ch3',label:'CH-3 Sense\n& Avoid',type:'challenge',layer:'challenges',x:700,y:40,w:120,h:44,color:'#eab308',desc:'Challenge: Obtain agreement on UAS "sense and avoid" definition, functional and performance requirements (Section 3.3.3).'},
  {id:'ch4',label:'CH-4 Frequency\nSpectrum',type:'challenge',layer:'challenges',x:700,y:100,w:130,h:44,color:'#eab308',desc:'Challenge: No C2 frequencies currently allocated or approved for UAS use. Requires national and international action (Section 3.3.4).'},
  {id:'ch5',label:'CH-5 Pilot\nQualifications',type:'challenge',layer:'challenges',x:700,y:160,w:130,h:44,color:'#eab308',desc:'Challenge: Appropriate minimum criteria for UAS pilots. Training, currency, testing, and medical standards needed (Section 3.3.5).'},
  {id:'ch6',label:'CH-6 Separation\nIssues',type:'challenge',layer:'challenges',x:700,y:220,w:120,h:44,color:'#eab308',desc:'Challenge: Appropriate separation standards for UAS — HALE UAS have long flexible wings susceptible to wake turbulence (Section 3.3.6).'},
  {id:'ch7',label:'CH-7 System\nSafety Analysis',type:'challenge',layer:'challenges',x:700,y:280,w:130,h:44,color:'#eab308',desc:'Challenge: Safety studies needed on individual elements and overall system. Must be compatible with FAA safety management plan (Section 3.3.7).'},
  // Issue markers (visual indicators on the canvas)
  {id:'issue_hitl_autoland',label:'CONFLICT\nHITL vs AutoLand',type:'issue',layer:'all',x:-440,y:430,w:140,h:40,color:'#fb7185',desc:'CONFLICT: REQ-HITL requires human override at all times, but Section 5.2 requires auto-land capability for C2 link loss. These requirements are in tension — on link loss, the human cannot be in the loop by definition.'},
  {id:'issue_c2_single',label:'CONFLICT\nC2 Redundancy',type:'issue',layer:'all',x:300,y:-20,w:140,h:40,color:'#fb7185',desc:'CONFLICT: Section 5.2 acknowledges that a single-channel C2 link may not provide the level of safety required. No explicit redundancy requirement exists in Table 2.'},
  {id:'issue_autonomy',label:'CONFLICT\nAutonomy vs HITL',type:'issue',layer:'all',x:-440,y:480,w:140,h:40,color:'#fb7185',desc:'CONFLICT: Assumption #25 states "autonomy is a system implementation preference" but REQ-HITL requires human always in loop. Ambiguity about permissible autonomy levels.'},
  {id:'issue_perf',label:'CONFLICT\nHALE IFR Perf',type:'issue',layer:'all',x:-200,y:430,w:140,h:40,color:'#fb7185',desc:'CONFLICT: Some existing HALE UAS (Pathfinder/Helios at 50 mph, slow turns) may not comply with IFR departure/arrival procedures designed for manned aircraft. CONOPS acknowledges specific routes may be needed (Section 4.5.3).'},
];

const EDGES = [
  // Composition
  {from:'sys',to:'ua',type:'composition',label:'deploys'},
  {from:'sys',to:'cs',type:'composition',label:'includes'},
  {from:'sys',to:'comms',type:'composition',label:'uses'},
  {from:'sys',to:'pilot',type:'composition',label:'operatedBy'},
  {from:'ua',to:'ua_airframe',type:'composition'},{from:'ua',to:'ua_prop',type:'composition'},
  {from:'ua',to:'ua_fltctrl',type:'composition'},{from:'ua',to:'ua_ca',type:'composition'},
  {from:'ua',to:'ua_nav',type:'composition'},{from:'ua',to:'ua_wx',type:'composition'},
  {from:'ua',to:'ua_frs',type:'composition'},{from:'ua',to:'ua_transponder',type:'composition'},
  {from:'ua',to:'ua_elec',type:'composition'},{from:'ua',to:'ua_autoland',type:'composition'},
  {from:'comms',to:'comms_los',type:'composition'},{from:'comms',to:'comms_oth',type:'composition'},
  {from:'comms',to:'comms_satcom',type:'composition'},{from:'comms',to:'comms_relay',type:'composition'},
  {from:'comms',to:'comms_landline',type:'composition'},
  // External interfaces
  {from:'sys',to:'ext_faa',type:'interface',label:'certification'},
  {from:'pilot',to:'ext_atc_dep',type:'interface',label:'voice/clearance'},
  {from:'pilot',to:'ext_tracon',type:'interface',label:'voice/radar'},
  {from:'pilot',to:'ext_atc_dest',type:'interface',label:'voice/clearance'},
  {from:'pilot',to:'ext_fss',type:'interface',label:'flight plan/wx'},
  {from:'sys',to:'ext_airport',type:'interface',label:'ground ops'},
  {from:'ua',to:'ext_other_ac',type:'interface',label:'sense & avoid'},
  {from:'comms',to:'ext_fcc',type:'interface',label:'spectrum auth'},
  // NEW external interfaces from review
  {from:'sys',to:'ext_icao',type:'interface',label:'intl compliance'},
  {from:'role_opsmgr',to:'cs',type:'interface',label:'mission plan'},
  {from:'role_ground',to:'ua',type:'interface',label:'preflight/taxi'},
  {from:'role_payload',to:'ua',type:'interface',label:'payload ops'},
  {from:'ua_transponder',to:'ext_other_ac',type:'interface',label:'cooperative surveillance'},
  {from:'comms',to:'ext_tracon',type:'interface',label:'voice relay'},
  {from:'ext_airport',to:'ext_fcc',type:'interface',label:'freq coordination'},
  // Internal data flows
  {from:'cs',to:'ua',type:'dataflow',label:'C2 commands'},
  {from:'ua',to:'cs',type:'dataflow',label:'telemetry'},
  {from:'pilot',to:'cs',type:'dataflow',label:'pilot input'},
  {from:'comms',to:'ua',type:'dataflow',label:'C2 uplink'},
  {from:'comms',to:'cs',type:'dataflow',label:'C2 downlink'},
  // Requirement satisfaction (ORIGINAL)
  {from:'r1',to:'ua',type:'satisfiedBy'},{from:'r1',to:'cs',type:'satisfiedBy'},
  {from:'r1_1',to:'ua',type:'satisfiedBy'},{from:'r1_2',to:'ua',type:'satisfiedBy'},
  {from:'r1_3',to:'ua',type:'satisfiedBy'},{from:'r1_3',to:'pilot',type:'satisfiedBy'},{from:'r1_3',to:'comms',type:'satisfiedBy'},
  {from:'r2_1',to:'sys',type:'satisfiedBy'},{from:'r2_2',to:'sys',type:'satisfiedBy'},
  {from:'r2_3',to:'pilot',type:'satisfiedBy'},
  // FIXED from review: REQ-2.3 also needs nav and comms
  {from:'r2_3',to:'ua_nav',type:'satisfiedBy'},{from:'r2_3',to:'comms',type:'satisfiedBy'},
  // ORIGINAL REQ-2.4
  {from:'r2_4',to:'ua',type:'satisfiedBy'},{from:'r2_4',to:'comms',type:'satisfiedBy'},
  // FIXED from review: REQ-2.4 also needs transponder and CA
  {from:'r2_4',to:'ua_transponder',type:'satisfiedBy'},{from:'r2_4',to:'ua_ca',type:'satisfiedBy'},
  // ORIGINAL
  {from:'r2_5',to:'pilot',type:'satisfiedBy'},
  // ORIGINAL REQ-2.6 + FIXES
  {from:'r2_6',to:'ua',type:'satisfiedBy'},{from:'r2_6',to:'sys',type:'satisfiedBy'},
  {from:'r2_6',to:'ua_frs',type:'satisfiedBy'},{from:'r2_6',to:'comms',type:'satisfiedBy'},
  // ORIGINAL
  {from:'r2_7',to:'comms',type:'satisfiedBy'},
  {from:'rd_ca',to:'ua_ca',type:'satisfiedBy'},
  // FIXED: REQ-PFC also needs flight controls and CS
  {from:'rd_pfc',to:'comms',type:'satisfiedBy'},{from:'rd_pfc',to:'ua_fltctrl',type:'satisfiedBy'},{from:'rd_pfc',to:'cs',type:'satisfiedBy'},
  {from:'rd_c2s',to:'comms',type:'satisfiedBy'},{from:'rd_c2s',to:'cs',type:'satisfiedBy'},
  // FIXED: REQ-HITL also needs CS
  {from:'rd_hitl',to:'comms',type:'satisfiedBy'},{from:'rd_hitl',to:'pilot',type:'satisfiedBy'},{from:'rd_hitl',to:'cs',type:'satisfiedBy'},
  // NEW requirement satisfaction links from review
  {from:'rd_nav',to:'ua_nav',type:'satisfiedBy'},
  {from:'rd_wx',to:'ua_wx',type:'satisfiedBy'},
  {from:'rd_atccomm',to:'comms',type:'satisfiedBy'},{from:'rd_atccomm',to:'pilot',type:'satisfiedBy'},
  {from:'rd_fltman',to:'sys',type:'satisfiedBy'},
  {from:'rd_fltplan',to:'cs',type:'satisfiedBy'},{from:'rd_fltplan',to:'pilot',type:'satisfiedBy'},
  {from:'rd_cns',to:'ua',type:'satisfiedBy'},{from:'rd_cns',to:'comms',type:'satisfiedBy'},{from:'rd_cns',to:'pilot',type:'satisfiedBy'},
  // Requirement hierarchy
  {from:'r0',to:'r1',type:'decomposition'},{from:'r0',to:'r2',type:'decomposition'},
  {from:'r1',to:'r1_1',type:'decomposition'},{from:'r1',to:'r1_2',type:'decomposition'},{from:'r1',to:'r1_3',type:'decomposition'},
  {from:'r2',to:'r2_1',type:'decomposition'},{from:'r2',to:'r2_2',type:'decomposition'},{from:'r2',to:'r2_3',type:'decomposition'},
  {from:'r2',to:'r2_4',type:'decomposition'},{from:'r2',to:'r2_5',type:'decomposition'},{from:'r2',to:'r2_6',type:'decomposition'},
  {from:'r2',to:'r2_7',type:'decomposition'},
  // Function hierarchy
  {from:'f1',to:'f1_1',type:'decomposition'},{from:'f1',to:'f1_2',type:'decomposition'},
  {from:'f1',to:'f1_3',type:'decomposition'},{from:'f1',to:'f1_4',type:'decomposition'},{from:'f1',to:'f1_5',type:'decomposition'},
  {from:'f1',to:'f1_6',type:'decomposition'},{from:'f1',to:'f1_7',type:'decomposition'},{from:'f1',to:'f1_8',type:'decomposition'},
  {from:'f2',to:'f2_1',type:'decomposition'},{from:'f2',to:'f2_2',type:'decomposition'},
  // Function allocation
  {from:'f1_1',to:'ua',type:'allocation'},{from:'f1_1',to:'cs',type:'allocation'},
  {from:'f1_2',to:'ua',type:'allocation'},{from:'f1_2',to:'pilot',type:'allocation'},{from:'f1_2',to:'ua_nav',type:'allocation'},
  {from:'f1_3',to:'ua_ca',type:'allocation'},{from:'f1_4',to:'comms',type:'allocation'},{from:'f1_4',to:'pilot',type:'allocation'},
  {from:'f1_5',to:'ua',type:'allocation'},{from:'f1_5',to:'cs',type:'allocation'},{from:'f1_5',to:'ua_frs',type:'allocation'},
  {from:'f1_6',to:'ua_wx',type:'allocation'},
  {from:'f1_7',to:'ua_autoland',type:'allocation'},{from:'f1_7',to:'ua_nav',type:'allocation'},
  {from:'f1_8',to:'cs',type:'allocation'},{from:'f1_8',to:'pilot',type:'allocation'},
  {from:'f2_1',to:'comms',type:'allocation'},{from:'f2_2',to:'comms',type:'allocation'},{from:'f2_2',to:'cs',type:'allocation'},
  // Mission links
  {from:'msn_loiter',to:'sys',type:'flownBy'},{from:'msn_ptp',to:'sys',type:'flownBy'},
  {from:'msn_loiter',to:'ext_airport',type:'interface',label:'depart/arrive'},
  {from:'msn_ptp',to:'ext_airport',type:'interface',label:'depart'},
  {from:'msn_loiter',to:'comms_los',type:'dataflow',label:'LOS only'},
  {from:'msn_ptp',to:'comms_oth',type:'dataflow',label:'OTH required'},
  // Challenge-to-requirement traces
  {from:'ch1',to:'r1_3',type:'challenges',label:'drives'},{from:'ch2',to:'r1_2',type:'challenges',label:'drives'},
  {from:'ch3',to:'rd_ca',type:'challenges',label:'drives'},{from:'ch4',to:'r2_7',type:'challenges',label:'drives'},
  {from:'ch5',to:'r2_5',type:'challenges',label:'drives'},{from:'ch6',to:'r2_4',type:'challenges',label:'drives'},
  {from:'ch7',to:'r1_3',type:'challenges',label:'drives'},{from:'ch7',to:'r0',type:'challenges',label:'drives'},
  // Issue conflict links
  {from:'issue_hitl_autoland',to:'rd_hitl',type:'conflict'},{from:'issue_hitl_autoland',to:'ua_autoland',type:'conflict'},
  {from:'issue_c2_single',to:'rd_pfc',type:'conflict'},{from:'issue_c2_single',to:'comms',type:'conflict'},
  {from:'issue_autonomy',to:'rd_hitl',type:'conflict'},
  {from:'issue_perf',to:'r2_3',type:'conflict'},
];

// =========================================================================
// ISSUES DATABASE
// =========================================================================
const ISSUES = [
  {id:1,type:'conflict',title:'REQ-HITL vs. Auto-Land Capability',desc:'REQ-HITL requires human override authority at ALL times, but Section 5.2 mandates auto-land capability for C2 link loss scenarios. On link loss, the human cannot be in the loop by definition. These requirements contradict each other.',refs:['rd_hitl','ua_autoland','f1_7'],severity:'high'},
  {id:2,type:'conflict',title:'Autonomy Preference vs. Human-in-Loop',desc:'Assumption #25 states "autonomy is a system implementation preference" — implying functions can be automated. But REQ-HITL requires human control at all times. The boundary between permissible autonomy and required human control is ambiguous.',refs:['rd_hitl'],severity:'high'},
  {id:3,type:'conflict',title:'Single-Channel C2 Link Safety Gap',desc:'Section 5.2 explicitly states a single-channel C2 link "may not provide the level of safety required." However, Table 2 has no explicit C2 redundancy requirement. REQ-PFC (positive flight control) implicitly requires this but does not mandate redundancy.',refs:['rd_pfc','comms','f2_1'],severity:'medium'},
  {id:4,type:'conflict',title:'HALE UAS IFR Performance Variability',desc:'Section 2.2 notes Pathfinder/Helios cruise at ~50 mph with very limited maneuvering. Section 4.5.3 acknowledges specific departure/arrival routes may be needed. REQ-2.3 (IFR operations) may not be achievable by all HALE UAS types without waivers.',refs:['r2_3','ua_airframe'],severity:'medium'},
  {id:5,type:'gap',title:'Missing Trace: ua_nav → Requirements',desc:'Navigation subsystem (ua_nav) had no requirement traceability. Section 5.2 specifies supplemental onboard navigation needed regardless of GPS status. FIXED: Added REQ-NAV.',refs:['ua_nav','rd_nav'],severity:'medium'},
  {id:6,type:'gap',title:'Missing Trace: ua_wx → Requirements',desc:'Weather Detection subsystem (ua_wx) had no requirement traceability. Section 5.2 specifies weather detection & avoidance. FIXED: Added REQ-WX.',refs:['ua_wx','rd_wx'],severity:'medium'},
  {id:7,type:'gap',title:'Missing Trace: REQ-2.3 → ua_nav, comms',desc:'REQ-2.3 (IFR Operations) was only traced to pilot. IFR operations also require navigation equipment on the UA and communication links. FIXED: Added traces.',refs:['r2_3','ua_nav','comms'],severity:'medium'},
  {id:8,type:'gap',title:'Missing Trace: REQ-2.4 → ua_transponder, ua_ca',desc:'REQ-2.4 (Separation Standards) was only traced to ua and comms. Separation requires transponder (cooperative surveillance) and collision avoidance. FIXED: Added traces.',refs:['r2_4','ua_transponder','ua_ca'],severity:'medium'},
  {id:9,type:'gap',title:'Missing Trace: REQ-PFC → ua_fltctrl, cs',desc:'REQ-PFC (Positive Flight Control) was only traced to comms. Positive flight control also requires flight control system and control station. FIXED: Added traces.',refs:['rd_pfc','ua_fltctrl','cs'],severity:'medium'},
  {id:10,type:'gap',title:'Missing: Section 4.6 NAS Integration Criteria',desc:'Section 4.6 lists 5 NAS integration criteria. Criteria #2 (flight manual), #3 (flight planning info to NAS), and #5 (CNS/ATM performance) were not captured. FIXED: Added REQ-FLTMAN, REQ-FLTPLN, REQ-CNS.',refs:['rd_fltman','rd_fltplan','rd_cns'],severity:'medium'},
  {id:11,type:'gap',title:'Missing: Challenge Areas (Section 3.3)',desc:'Seven challenge areas were not represented in the model. These drive requirements and identify unresolved issues. FIXED: Added CH-1 through CH-7 with traces to requirements.',refs:['ch1','ch2','ch3','ch4','ch5','ch6','ch7'],severity:'low'},
  {id:12,type:'gap',title:'Missing: Table 3 Stakeholder Roles',desc:'Table 3 defines Ops Manager, Ground Crew, and Payload Ops roles not captured in the system model. These actors interface with components during mission operations. FIXED: Added role nodes.',refs:['role_opsmgr','role_ground','role_payload'],severity:'low'},
];

// =========================================================================
// CANVAS STATE
// =========================================================================
let cam = {x:0, y:0, zoom:1};
let dragStart = null, camStart = null;
let hoveredNode = null, selectedNode = null;
let activeLayer = 'all';
let searchTerm = '';
let issuesOpen = false;
const mainCanvas = document.getElementById('mainCanvas');
const connCanvas = document.getElementById('connCanvas');
const ctx = mainCanvas.getContext('2d');
const cctx = connCanvas.getContext('2d');
const ws = document.getElementById('workspace');

function resize(){
  const r = window.devicePixelRatio||1;
  const w = ws.clientWidth, h = ws.clientHeight;
  [mainCanvas, connCanvas].forEach(c=>{c.width=w*r;c.height=h*r;c.style.width=w+'px';c.style.height=h+'px';c.getContext('2d').setTransform(r,0,0,r,0,0)});
  draw();
}
window.addEventListener('resize', resize);

function worldToScreen(wx, wy){return[(wx-cam.x)*cam.zoom+mainCanvas.clientWidth/2,(wy-cam.y)*cam.zoom+mainCanvas.clientHeight/2]}
function screenToWorld(sx, sy){return[(sx-mainCanvas.clientWidth/2)/cam.zoom+cam.x,(sy-mainCanvas.clientHeight/2)/cam.zoom+cam.y]}

// =========================================================================
// VISIBILITY
// =========================================================================
function isVisible(node){
  if(activeLayer!=='all' && node.layer!==activeLayer){
    // Allow issues to show in all layers
    if(node.type==='issue' && node.layer==='all') return true;
    if(activeLayer==='physical' && (node.layer==='requirements'||node.layer==='functions'||node.layer==='missions'||node.layer==='challenges')) return false;
    if(activeLayer!=='physical' && node.layer!=='physical' && node.layer!==activeLayer) return false;
    if(activeLayer==='physical' && node.layer==='physical') { /* ok */ }
    else return false;
  }
  if(searchTerm){
    const s = searchTerm.toLowerCase();
    if(!node.label.toLowerCase().includes(s) && !node.id.toLowerCase().includes(s) && !(node.desc||'').toLowerCase().includes(s)) return false;
  }
  // Check if parent is expanded
  const parentEdge = EDGES.find(e=>e.to===node.id && e.type==='composition');
  if(parentEdge){
    const parent = NODES.find(n=>n.id===parentEdge.from);
    if(parent && parent.expanded===false && parent.children) return false;
  }
  return true;
}
function isEdgeVisible(edge){
  const from=NODES.find(n=>n.id===edge.from), to=NODES.find(n=>n.id===edge.to);
  if(!from||!to) return false;
  if(!isVisible(from)||!isVisible(to)) return false;
  if(activeLayer==='physical' && (edge.type==='satisfiedBy'||edge.type==='allocation'||edge.type==='challenges'||edge.type==='conflict')) return false;
  if(activeLayer==='physical' && edge.type==='decomposition'&&from.layer==='requirements') return false;
  if(activeLayer==='requirements' && (edge.type==='allocation'||edge.type==='dataflow'||edge.type==='flownBy')) return false;
  if(activeLayer==='functions' && (edge.type==='satisfiedBy'||edge.type==='flownBy'||edge.type==='challenges'||edge.type==='conflict')) return false;
  if(activeLayer==='functions' && edge.type==='decomposition'&&from.layer==='requirements') return false;
  if(activeLayer==='missions' && edge.type==='decomposition') return false;
  return true;
}

// =========================================================================
// DRAWING
// =========================================================================
function draw(){
  const W=mainCanvas.clientWidth, H=mainCanvas.clientHeight;
  ctx.clearRect(0,0,W,H);
  cctx.clearRect(0,0,W,H);

  // Draw edges
  EDGES.forEach(edge=>{
    if(!isEdgeVisible(edge)) return;
    const from=NODES.find(n=>n.id===edge.from), to=NODES.find(n=>n.id===edge.to);
    const [x1,y1]=worldToScreen(from.x, from.y);
    const [x2,y2]=worldToScreen(to.x, to.y);
    const isHighlight = selectedNode && (edge.from===selectedNode.id || edge.to===selectedNode.id);

    cctx.beginPath();
    cctx.moveTo(x1,y1); cctx.lineTo(x2,y2);
    const styles={
      composition:{color:'#475569',width:1.5,dash:[]},
      interface:{color:'#a78bfa',width:1,dash:[6,3]},
      dataflow:{color:'#38bdf8',width:1,dash:[3,3]},
      satisfiedBy:{color:'#f59e0b',width:1,dash:[4,4]},
      decomposition:{color:'#64748b',width:1,dash:[]},
      allocation:{color:'#ef4444',width:1,dash:[5,3]},
      flownBy:{color:'#f472b6',width:1,dash:[4,3]},
      challenges:{color:'#eab308',width:1.5,dash:[6,3]},
      conflict:{color:'#fb7185',width:2,dash:[3,3]}
    };
    const s = styles[edge.type]||styles.composition;
    cctx.strokeStyle = isHighlight ? '#fff' : s.color;
    cctx.lineWidth = (isHighlight ? s.width+1 : s.width) * cam.zoom;
    cctx.globalAlpha = isHighlight ? 1 : (edge.type==='conflict'?0.8:0.5);
    cctx.setLineDash(s.dash.map(d=>d*cam.zoom));
    cctx.stroke();
    cctx.setLineDash([]);
    cctx.globalAlpha = 1;

    // Edge label
    if(edge.label && cam.zoom > 0.6){
      const mx=(x1+x2)/2, my=(y1+y2)/2;
      cctx.font=`${9*cam.zoom}px system-ui`;
      cctx.fillStyle=isHighlight?'#fff':'#64748b';
      cctx.textAlign='center';
      cctx.fillText(edge.label, mx, my-4*cam.zoom);
    }

    // Arrowhead
    if(edge.type!=='composition'){
      const angle=Math.atan2(y2-y1,x2-x1);
      const sz=6*cam.zoom;
      cctx.beginPath();
      cctx.moveTo(x2,y2);
      cctx.lineTo(x2-sz*Math.cos(angle-0.4),y2-sz*Math.sin(angle-0.4));
      cctx.lineTo(x2-sz*Math.cos(angle+0.4),y2-sz*Math.sin(angle+0.4));
      cctx.closePath();
      cctx.fillStyle=isHighlight?'#fff':s.color;
      cctx.globalAlpha=isHighlight?1:0.6;
      cctx.fill();
      cctx.globalAlpha=1;
    }
    // Diamond for composition
    if(edge.type==='composition'){
      const angle=Math.atan2(y1-y2,x1-x2);
      const sz=7*cam.zoom;
      const bx=x1, by=y1;
      cctx.beginPath();
      cctx.moveTo(bx+sz*Math.cos(angle),by+sz*Math.sin(angle));
      cctx.lineTo(bx+sz*Math.cos(angle+Math.PI/2)*0.5,by+sz*Math.sin(angle+Math.PI/2)*0.5);
      cctx.lineTo(bx-sz*Math.cos(angle),by-sz*Math.sin(angle));
      cctx.lineTo(bx-sz*Math.cos(angle+Math.PI/2)*0.5,by-sz*Math.sin(angle+Math.PI/2)*0.5);
      cctx.closePath();
      cctx.fillStyle=isHighlight?'#fff':'#475569';
      cctx.fill();
    }
  });

  // Draw nodes
  NODES.forEach(node=>{
    if(!isVisible(node)) return;
    const [sx,sy]=worldToScreen(node.x, node.y);
    const w=node.w*cam.zoom, h=node.h*cam.zoom;
    const isHover = hoveredNode===node;
    const isSel = selectedNode===node;
    const isConnected = selectedNode && EDGES.some(e=>(e.from===selectedNode.id&&e.to===node.id)||(e.to===selectedNode.id&&e.from===node.id));
    const dimmed = selectedNode && !isSel && !isConnected;

    ctx.globalAlpha = dimmed ? 0.25 : 1;

    // Shadow
    ctx.shadowColor='rgba(0,0,0,0.3)';ctx.shadowBlur=isHover?12:6;ctx.shadowOffsetY=2;

    // Special rendering for issue nodes
    if(node.type==='issue'){
      ctx.beginPath();
      ctx.roundRect(sx-w/2, sy-h/2, w, h, 6*cam.zoom);
      ctx.fillStyle = '#fb718530';
      ctx.fill();
      ctx.strokeStyle = isSel ? '#fff' : '#fb7185';
      ctx.lineWidth = (isSel?3:2)*cam.zoom;
      ctx.setLineDash([4*cam.zoom,3*cam.zoom]);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.shadowBlur=0;ctx.shadowOffsetY=0;
      // Warning icon
      if(cam.zoom > 0.4){
        ctx.font=`${14*cam.zoom}px system-ui`;
        ctx.fillStyle='#fb7185';
        ctx.textAlign='center';
        ctx.fillText('⚠', sx-w/2+12*cam.zoom, sy-h/2+14*cam.zoom);
      }
    } else {
      // Body
      const r=6*cam.zoom;
      ctx.beginPath();
      ctx.roundRect(sx-w/2, sy-h/2, w, h, r);
      ctx.fillStyle = node.color + (node.type==='external'?'30':'20');
      ctx.fill();
      ctx.strokeStyle = isSel ? '#fff' : isHover ? '#e2e8f0' : node.color;
      ctx.lineWidth = (isSel||isHover?2.5:1.5)*cam.zoom;
      ctx.stroke();
      ctx.shadowBlur=0;ctx.shadowOffsetY=0;

      // Top color bar
      ctx.beginPath();
      ctx.roundRect(sx-w/2, sy-h/2, w, 4*cam.zoom, [r,r,0,0]);
      ctx.fillStyle=node.color;
      ctx.fill();
    }

    // Label
    if(cam.zoom > 0.3){
      const lines = node.label.split('\n');
      ctx.font=`${(isSel?'bold ':'600 ')}${Math.max(8,10*cam.zoom)}px system-ui`;
      ctx.fillStyle=node.type==='issue'?'#fb7185':'#fff';
      ctx.textAlign='center';
      lines.forEach((line,i)=>{
        ctx.fillText(line, sx, sy + (i - (lines.length-1)/2)*13*cam.zoom + 4*cam.zoom);
      });
    }

    // Expand indicator
    if(node.children && node.children.length && cam.zoom > 0.4){
      const ex=sx+w/2-8*cam.zoom, ey=sy-h/2+8*cam.zoom;
      ctx.beginPath();ctx.arc(ex,ey,6*cam.zoom,0,Math.PI*2);
      ctx.fillStyle='rgba(255,255,255,0.15)';ctx.fill();
      ctx.font=`${10*cam.zoom}px system-ui`;ctx.fillStyle='#fff';
      ctx.fillText(node.expanded?'−':'+', ex, ey+3.5*cam.zoom);
    }

    // Issue indicator on nodes that have issues
    if(node.type!=='issue'){
      const hasIssue = ISSUES.some(iss=>iss.refs.includes(node.id));
      if(hasIssue && cam.zoom > 0.4){
        const ix=sx-w/2+8*cam.zoom, iy=sy-h/2+8*cam.zoom;
        ctx.beginPath();ctx.arc(ix,iy,5*cam.zoom,0,Math.PI*2);
        ctx.fillStyle='#fb7185';ctx.fill();
        ctx.font=`bold ${7*cam.zoom}px system-ui`;ctx.fillStyle='#fff';ctx.textAlign='center';
        ctx.fillText('!',ix,iy+2.5*cam.zoom);
      }
    }

    ctx.globalAlpha=1;
  });
}

// =========================================================================
// INTERACTION
// =========================================================================
function getNodeAt(sx, sy){
  const [wx,wy]=screenToWorld(sx,sy);
  for(let i=NODES.length-1;i>=0;i--){
    const n=NODES[i];
    if(!isVisible(n)) continue;
    if(wx>=n.x-n.w/2 && wx<=n.x+n.w/2 && wy>=n.y-n.h/2 && wy<=n.y+n.h/2) return n;
  }
  return null;
}

mainCanvas.addEventListener('mousedown',e=>{
  const rect=mainCanvas.getBoundingClientRect();
  const sx=e.clientX-rect.left, sy=e.clientY-rect.top;
  const node=getNodeAt(sx,sy);
  if(node){
    // Check expand button
    const [nsx,nsy]=worldToScreen(node.x,node.y);
    const nw=node.w*cam.zoom, nh=node.h*cam.zoom;
    const ex=nsx+nw/2-8*cam.zoom, ey=nsy-nh/2+8*cam.zoom;
    if(node.children && Math.hypot(sx-ex,sy-ey)<10*cam.zoom){
      node.expanded=!node.expanded;
      draw();
      return;
    }
    selectedNode=node;
    openPanel(node);
    draw();
    return;
  }
  dragStart={x:e.clientX,y:e.clientY};
  camStart={x:cam.x,y:cam.y};
});

mainCanvas.addEventListener('mousemove',e=>{
  const rect=mainCanvas.getBoundingClientRect();
  const sx=e.clientX-rect.left, sy=e.clientY-rect.top;
  if(dragStart){
    cam.x=camStart.x-(e.clientX-dragStart.x)/cam.zoom;
    cam.y=camStart.y-(e.clientY-dragStart.y)/cam.zoom;
    draw();
    return;
  }
  const node=getNodeAt(sx,sy);
  if(node!==hoveredNode){
    hoveredNode=node;
    mainCanvas.style.cursor=node?'pointer':'grab';
    const tt=document.getElementById('tooltip');
    if(node){
      tt.innerHTML=`<strong>${node.label.replace(/\n/g,' ')}</strong><br><span style="color:#94a3b8">${(node.desc||'').substring(0,140)}${(node.desc||'').length>140?'...':''}</span>`;
      tt.style.display='block';
      tt.style.left=(e.clientX-rect.left+12)+'px';
      tt.style.top=(e.clientY-rect.top-10)+'px';
    } else {
      tt.style.display='none';
    }
    draw();
  } else if(node){
    const tt=document.getElementById('tooltip');
    tt.style.left=(e.clientX-rect.left+12)+'px';
    tt.style.top=(e.clientY-rect.top-10)+'px';
  }
});

mainCanvas.addEventListener('mouseup',()=>{dragStart=null});
mainCanvas.addEventListener('mouseleave',()=>{dragStart=null;document.getElementById('tooltip').style.display='none'});

mainCanvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const factor=e.deltaY>0?0.9:1.1;
  const rect=mainCanvas.getBoundingClientRect();
  const sx=e.clientX-rect.left, sy=e.clientY-rect.top;
  const [wx,wy]=screenToWorld(sx,sy);
  cam.zoom=Math.max(0.15,Math.min(4,cam.zoom*factor));
  cam.x=wx-(sx-mainCanvas.clientWidth/2)/cam.zoom;
  cam.y=wy-(sy-mainCanvas.clientHeight/2)/cam.zoom;
  draw();
},{passive:false});

mainCanvas.addEventListener('dblclick',e=>{
  const rect=mainCanvas.getBoundingClientRect();
  const node=getNodeAt(e.clientX-rect.left,e.clientY-rect.top);
  if(node){
    cam.x=node.x; cam.y=node.y; cam.zoom=1.8;
    draw();
  }
});

// =========================================================================
// DETAIL PANEL
// =========================================================================
function openPanel(node){
  const panel=document.getElementById('detailPanel');
  const icon=document.getElementById('dpIcon');
  const title=document.getElementById('dpTitle');
  const content=document.getElementById('dpContent');

  icon.style.background=node.color;
  icon.textContent=node.type==='issue'?'!':node.type[0].toUpperCase();
  title.textContent=node.label.replace(/\n/g,' ');

  let html=`<div class="dp-section"><h3>Description</h3><p>${node.desc||'—'}</p></div>`;

  // Show issues for this node
  const nodeIssues = ISSUES.filter(iss=>iss.refs.includes(node.id));
  if(nodeIssues.length){
    html+=`<div class="dp-section" style="background:rgba(251,113,133,.06)"><h3 style="color:#fb7185">Review Issues (${nodeIssues.length})</h3>`;
    nodeIssues.forEach(iss=>{
      html+=`<div style="margin-bottom:8px;padding:6px 8px;background:rgba(251,113,133,.08);border-radius:6px;border-left:3px solid ${iss.type==='conflict'?'#fb7185':'#f59e0b'}">`;
      html+=`<div style="font-size:10px;font-weight:700;color:${iss.type==='conflict'?'#fb7185':'#f59e0b'};text-transform:uppercase;margin-bottom:2px">${iss.type} — ${iss.severity}</div>`;
      html+=`<div style="font-size:11px;font-weight:600;color:#fff;margin-bottom:3px">${iss.title}</div>`;
      html+=`<div style="font-size:10px;color:#94a3b8;line-height:1.5">${iss.desc}</div></div>`;
    });
    html+=`</div>`;
  }

  // Properties
  if(node.props){
    html+=`<div class="dp-section"><h3>Properties</h3><div class="dp-props">`;
    for(const[k,v] of Object.entries(node.props)){
      const display = v===true?'<span style="color:#10b981">&#10003; True</span>':v===false?'<span style="color:#ef4444">&#10007; False</span>':v;
      html+=`<div class="dp-prop"><div class="k">${k}</div><div class="v">${display}</div></div>`;
    }
    html+=`</div></div>`;
  }

  // Connections
  const conns=EDGES.filter(e=>e.from===node.id||e.to===node.id);
  if(conns.length){
    const grouped={};
    conns.forEach(e=>{
      const t=e.type;
      if(!grouped[t]) grouped[t]=[];
      const otherId=e.from===node.id?e.to:e.from;
      const other=NODES.find(n=>n.id===otherId);
      const dir=e.from===node.id?'→':'←';
      grouped[t].push({other,dir,label:e.label||''});
    });
    html+=`<div class="dp-section"><h3>Connections (${conns.length})</h3>`;
    for(const[type,items] of Object.entries(grouped)){
      const typeColors={composition:'#475569',interface:'#a78bfa',dataflow:'#38bdf8',satisfiedBy:'#f59e0b',decomposition:'#64748b',allocation:'#ef4444',flownBy:'#f472b6',challenges:'#eab308',conflict:'#fb7185'};
      html+=`<div style="margin-bottom:8px"><span class="dp-tag" style="background:${typeColors[type]||'#475569'}30;color:${typeColors[type]||'#475569'}">${type}</span></div>`;
      items.forEach(item=>{
        if(item.other){
          html+=`<div class="dp-conn" onclick="navigateTo('${item.other.id}')"><span class="arrow">${item.dir}</span><span style="color:${item.other.color}">${item.other.label.replace(/\n/g,' ')}</span>${item.label?`<span style="color:var(--muted);font-size:10px;margin-left:auto">${item.label}</span>`:''}</div>`;
        }
      });
    }
    html+=`</div>`;
  }

  content.innerHTML=html;
  panel.classList.add('open');
}

function closePanel(){
  document.getElementById('detailPanel').classList.remove('open');
  selectedNode=null;
  draw();
}

function navigateTo(nodeId){
  const node=NODES.find(n=>n.id===nodeId);
  if(!node) return;
  const parentEdge=EDGES.find(e=>e.to===node.id&&e.type==='composition');
  if(parentEdge){const parent=NODES.find(n=>n.id===parentEdge.from);if(parent&&parent.expanded===false)parent.expanded=true}
  cam.x=node.x; cam.y=node.y;
  selectedNode=node;
  openPanel(node);
  draw();
}

// =========================================================================
// ISSUES DRAWER
// =========================================================================
function toggleIssues(){
  issuesOpen=!issuesOpen;
  document.getElementById('issuesDrawer').classList.toggle('open',issuesOpen);
  document.getElementById('btnIssues').classList.toggle('active',issuesOpen);
}

function renderIssues(){
  const list=document.getElementById('issuesList');
  let html='';
  ISSUES.forEach(iss=>{
    const isConflict=iss.type==='conflict';
    html+=`<div class="issue-card" onclick="focusIssue(${iss.id})">`;
    html+=`<div class="issue-type"><span class="dot" style="background:${isConflict?'#fb7185':'#f59e0b'}"></span><span style="color:${isConflict?'#fb7185':'#f59e0b'}">${iss.type}</span><span style="margin-left:auto;font-size:9px;color:#94a3b8">${iss.severity}</span></div>`;
    html+=`<div class="issue-title">${iss.title}</div>`;
    html+=`<div class="issue-desc">${iss.desc}</div>`;
    html+=`<div class="issue-refs">`;
    iss.refs.forEach(ref=>{
      const node=NODES.find(n=>n.id===ref);
      if(node) html+=`<span class="ref-chip" onclick="event.stopPropagation();navigateTo('${ref}')">${node.label.replace(/\n/g,' ')}</span>`;
    });
    html+=`</div></div>`;
  });
  list.innerHTML=html;
}

function focusIssue(issueId){
  const iss=ISSUES.find(i=>i.id===issueId);
  if(!iss||!iss.refs.length) return;
  const node=NODES.find(n=>n.id===iss.refs[0]);
  if(node){
    navigateTo(node.id);
  }
}

// =========================================================================
// CONTROLS
// =========================================================================
function setLayer(layer){
  activeLayer=layer;
  document.querySelectorAll('.controls button:not(.issues-btn)').forEach(b=>b.classList.remove('active'));
  const btnMap={all:'btnAll',physical:'btnPhys',requirements:'btnReq',functions:'btnFunc',missions:'btnMsn',challenges:'btnChal'};
  if(btnMap[layer]) document.getElementById(btnMap[layer]).classList.add('active');
  draw();
}

function resetView(){cam={x:0,y:0,zoom:0.75};selectedNode=null;closePanel();draw()}

function searchNodes(term){searchTerm=term;draw()}

// =========================================================================
// INIT
// =========================================================================
resize();
resetView();
renderIssues();
</script>
</body>
</html>
